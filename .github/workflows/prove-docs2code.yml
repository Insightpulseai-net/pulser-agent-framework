# =============================================================================
# DOCS2CODE PROOF HARNESS - CI/CD WORKFLOW
# =============================================================================
# Runs deterministic proof harness on every PR and scheduled intervals.
# Enforces quality gates before merge.
#
# Triggers:
#   - Pull requests to main/develop
#   - Manual dispatch (workflow_dispatch)
#   - Daily schedule (6 AM UTC)
#
# Jobs:
#   - proof-harness: Run full proof suite
#   - code-quality: Lint and type check
#   - test-suite: Run pytest
#   - summary: Aggregate results
# =============================================================================

name: Docs2Code Proof

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'
        type: boolean
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # JOB 1: PROOF HARNESS
  # ===========================================================================
  proof-harness:
    name: Proof Harness
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Make proof script executable
        run: chmod +x scripts/prove_docs2code.sh

      - name: Run proof harness
        id: proof
        run: |
          ./scripts/prove_docs2code.sh
        continue-on-error: true

      - name: Check proof results
        run: |
          # Find the latest proof directory
          LATEST_PROOF=$(ls -td artifacts/proof/*/ 2>/dev/null | head -1)
          if [ -n "$LATEST_PROOF" ]; then
            echo "=== PROOF SUMMARY ==="
            cat "${LATEST_PROOF}summary.md" || echo "No summary found"
            echo ""
            echo "=== TEST RESULTS ==="
            cat "${LATEST_PROOF}test_results.json" || echo "No results found"
          else
            echo "No proof artifacts found"
          fi

      - name: Upload proof artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: proof-artifacts-${{ github.run_id }}
          path: artifacts/proof/
          retention-days: 30

      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find latest proof directory
            const proofDir = 'artifacts/proof';
            let summary = 'No proof results available';

            try {
              const dirs = fs.readdirSync(proofDir)
                .filter(d => fs.statSync(path.join(proofDir, d)).isDirectory())
                .sort()
                .reverse();

              if (dirs.length > 0) {
                const summaryPath = path.join(proofDir, dirs[0], 'summary.md');
                if (fs.existsSync(summaryPath)) {
                  summary = fs.readFileSync(summaryPath, 'utf8');
                }
              }
            } catch (e) {
              console.log('Could not read proof summary:', e.message);
            }

            const body = `## Docs2Code Proof Results

            ${summary}

            ---
            *Workflow run: ${{ github.run_id }}*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if proof failed
        if: steps.proof.outcome == 'failure'
        run: exit 1

  # ===========================================================================
  # JOB 2: CODE QUALITY
  # ===========================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Run flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics \
            --exclude=.git,__pycache__,build,dist,*.egg-info,node_modules,.venv,venv
        continue-on-error: true

      - name: Check Python formatting
        run: |
          black --check --diff . \
            --exclude='/(\.git|__pycache__|build|dist|\.egg-info|node_modules|\.venv|venv)/' \
            2>/dev/null || echo "Formatting check skipped (no Python files or black not configured)"
        continue-on-error: true

      - name: Check import sorting
        run: |
          isort --check-only --diff . \
            --skip .git --skip __pycache__ --skip build --skip dist \
            --skip node_modules --skip .venv --skip venv \
            2>/dev/null || echo "Import check skipped"
        continue-on-error: true

  # ===========================================================================
  # JOB 3: TEST SUITE
  # ===========================================================================
  test-suite:
    name: Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio pyyaml
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi

      - name: Run tests
        env:
          DATABASE_URL: postgresql://test_user:test_pass@localhost:5432/test_db
        run: |
          if [ -d "tests" ] && [ "$(find tests -name 'test_*.py' | wc -l)" -gt 0 ]; then
            pytest tests/ -v --tb=short --cov=. --cov-report=term-missing || true
          else
            echo "No tests found in tests/ directory"
          fi

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.run_id }}
          path: |
            .coverage
            htmlcov/
          retention-days: 7

  # ===========================================================================
  # JOB 4: SUMMARY
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [proof-harness, code-quality, test-suite]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "=== WORKFLOW SUMMARY ==="
          echo ""
          echo "Proof Harness: ${{ needs.proof-harness.result }}"
          echo "Code Quality:  ${{ needs.code-quality.result }}"
          echo "Test Suite:    ${{ needs.test-suite.result }}"
          echo ""

          if [ "${{ needs.proof-harness.result }}" == "failure" ]; then
            echo "❌ Proof harness failed - PR should not be merged"
            exit 1
          fi

          echo "✅ All critical checks passed"

      - name: Create summary
        run: |
          echo "## Docs2Code CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Proof Harness | ${{ needs.proof-harness.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result == 'success' && '✅ Passed' || '⚠️ Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | ${{ needs.test-suite.result == 'success' && '✅ Passed' || '⚠️ Incomplete' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "*Run ID: ${{ github.run_id }}*" >> $GITHUB_STEP_SUMMARY
