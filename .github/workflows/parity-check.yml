# =============================================================================
# PARITY CHECK WORKFLOW
# =============================================================================
# Validates AFC Close Manager parity score against SAP AFC/GRC/Signavio
# Fails build if parity score drops below threshold
# =============================================================================

name: Parity Check

'on':
  push:
    branches: [main, develop, 'feature/**', 'claude/**']
    paths:
      - 'tools/parity/**'
      - '.github/workflows/parity-check.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'tools/parity/**'
  workflow_dispatch:
    inputs:
      min_score:
        description: 'Minimum parity score (0.0-1.0)'
        required: false
        default: '0.85'

env:
  PYTHON_VERSION: '3.11'
  MIN_PARITY_SCORE: '0.85'

jobs:
  parity-check:
    name: Parity Score Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Generate parity report
        id: parity
        run: |
          cd tools/parity

          # Use workflow dispatch input or default
          MIN_SCORE="${{ github.event.inputs.min_score || env.MIN_PARITY_SCORE }}"

          python paritygen.py \
            parity.yml \
            profiles/ipai_odoo_ce_18.yml \
            --min-score="$MIN_SCORE" \
            --out-dir=out

          # Extract score for summary
          SCORE=$(python -c "import json; print(json.load(open('out/summary.json'))['parity_score'])")
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "### Parity Score: $(echo "$SCORE * 100" | bc)%" >> $GITHUB_STEP_SUMMARY

      - name: Upload parity artifacts
        uses: actions/upload-artifact@v4
        with:
          name: parity-report
          path: tools/parity/out/
          retention-days: 30

      - name: Post parity summary
        run: |
          cat tools/parity/out/summary.json
          echo ""
          echo "=== Parity Checklist Preview ==="
          head -100 tools/parity/out/PARITY_CHECKLIST.md

  parity-diff:
    name: Parity Diff (PRs only)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: parity-check

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate base parity
        run: |
          cd base/tools/parity
          python paritygen.py parity.yml profiles/ipai_odoo_ce_18.yml --out-dir=out 2>/dev/null || true

      - name: Generate PR parity
        run: |
          cd tools/parity
          python paritygen.py parity.yml profiles/ipai_odoo_ce_18.yml --out-dir=out

      - name: Compare parity scores
        run: |
          BASE_SCORE=$(python -c "import json; print(json.load(open('base/tools/parity/out/summary.json'))['parity_score'])" 2>/dev/null || echo "0")
          PR_SCORE=$(python -c "import json; print(json.load(open('tools/parity/out/summary.json'))['parity_score'])")

          DIFF=$(python -c "print(f'{($PR_SCORE - $BASE_SCORE) * 100:+.1f}%')")

          echo "### Parity Score Change" >> $GITHUB_STEP_SUMMARY
          echo "- **Base:** $(echo "$BASE_SCORE * 100" | bc)%" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** $(echo "$PR_SCORE * 100" | bc)%" >> $GITHUB_STEP_SUMMARY
          echo "- **Change:** $DIFF" >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('tools/parity/out/summary.json', 'utf8'));
            const score = (summary.parity_score * 100).toFixed(1);

            const body = `## üìä Parity Score: ${score}%

            | Status | Count |
            |--------|-------|
            | ‚úÖ Done | ${summary.counts.done} |
            | üü° Partial | ${summary.counts.partial} |
            | üß≠ Planned | ${summary.counts.planned} |
            | ‚ùå No | ${summary.counts.no} |

            | Priority | Count |
            |----------|-------|
            | Core | ${summary.by_priority.core} |
            | Important | ${summary.by_priority.important} |
            | Nice | ${summary.by_priority.nice} |

            [View full report](../actions/runs/${context.runId})`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
