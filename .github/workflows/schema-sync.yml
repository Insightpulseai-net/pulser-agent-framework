# .github/workflows/schema-sync.yml
name: Schema & Docs in Sync

on:
  pull_request:

jobs:
  check-sync:
    runs-on: ubuntu-latest
    env:
      DB_URL: ${{ secrets.CI_DB_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install tools
        run: |
          pip install psycopg2-binary
          sudo apt-get update
          sudo apt-get install -y tree postgresql-client

      - name: Apply migrations to shadow DB
        run: |
          make db-migrate

      - name: Regenerate schema + docs + file tree
        run: |
          make db-schema-dump
          # these can be stubs until you implement them
          make docs-schema-md || true
          make docs-filetree || true

      - name: Ensure no drift in tracked files
        run: |
          git diff --exit-code db/schema.sql docs/SCHEMA.md README.md || {
            echo "Detected drift in schema/docs/file tree. Run the make commands locally and commit the results."
            exit 1
          }
