{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://insightpulseai.com/schemas/docir/v1",
  "title": "DocIR - Document Intermediate Representation",
  "description": "Deterministic intermediate representation for docs-to-code pipeline. All generated code traces back to this IR.",
  "type": "object",
  "required": ["doc_id", "version", "sources", "requirements"],
  "properties": {
    "doc_id": {
      "type": "string",
      "pattern": "^[a-z0-9-]+$",
      "description": "Unique identifier for the document set"
    },
    "version": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
      "description": "ISO date version of the IR"
    },
    "sources": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/Source"
      },
      "description": "Source documents that feed into this IR"
    },
    "requirements": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/Requirement"
      },
      "description": "Extracted requirements with acceptance criteria"
    },
    "schemas": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/SchemaDefinition"
      },
      "description": "JSON Schema definitions for interfaces"
    },
    "architecture_decisions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/ArchitectureDecision"
      },
      "description": "ADRs extracted from documentation"
    },
    "compliance_rules": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/ComplianceRule"
      },
      "description": "Regulatory/compliance rules that must be enforced"
    },
    "module_map": {
      "type": "object",
      "additionalProperties": {
        "$ref": "#/definitions/ModuleSpec"
      },
      "description": "Target module structure mapping"
    },
    "metadata": {
      "$ref": "#/definitions/Metadata"
    }
  },
  "definitions": {
    "Source": {
      "type": "object",
      "required": ["uri", "hash", "source_type"],
      "properties": {
        "uri": {
          "type": "string",
          "description": "Source document URI (notion://, gdoc://, github://, bir://, etc.)"
        },
        "hash": {
          "type": "string",
          "pattern": "^sha256:[a-f0-9]{64}$",
          "description": "SHA256 content hash for change detection"
        },
        "source_type": {
          "type": "string",
          "enum": ["sap_s4hana", "microsoft_learn", "odoo_core", "oca_modules", "bir_regulatory", "databricks_arch", "figma_design", "notion", "gdoc", "markdown"],
          "description": "Type of source document"
        },
        "extracted_at": {
          "type": "string",
          "format": "date-time"
        },
        "extraction_confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        }
      }
    },
    "Requirement": {
      "type": "object",
      "required": ["id", "title", "priority", "source_spans", "acceptance"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^REQ-\\d{3,}$",
          "description": "Stable requirement ID"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200
        },
        "description": {
          "type": "string"
        },
        "priority": {
          "type": "string",
          "enum": ["P0", "P1", "P2", "P3"],
          "description": "P0=critical, P1=high, P2=medium, P3=low"
        },
        "source_spans": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/SourceSpan"
          },
          "description": "Traceability to source documents"
        },
        "acceptance": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/AcceptanceCriterion"
          }
        },
        "interfaces": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/InterfaceRef"
          }
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^REQ-\\d{3,}$"
          }
        },
        "compliance_refs": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^(BIR|PFRS|PAS|SOX|DOLE)_[A-Z0-9_-]+$"
          }
        }
      }
    },
    "SourceSpan": {
      "type": "object",
      "required": ["uri"],
      "properties": {
        "uri": {
          "type": "string"
        },
        "start": {
          "type": "integer",
          "minimum": 0
        },
        "end": {
          "type": "integer",
          "minimum": 0
        },
        "heading": {
          "type": "string"
        },
        "quote": {
          "type": "string",
          "maxLength": 500
        }
      }
    },
    "AcceptanceCriterion": {
      "type": "object",
      "required": ["id", "type", "assert"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^AC-\\d{3,}[a-z]?$"
        },
        "type": {
          "type": "string",
          "enum": ["unit", "integration", "e2e", "perf", "security", "manual"],
          "description": "Test type for this criterion"
        },
        "assert": {
          "type": "string",
          "description": "Machine-checkable assertion or description"
        },
        "threshold": {
          "type": "object",
          "properties": {
            "metric": {
              "type": "string"
            },
            "operator": {
              "type": "string",
              "enum": ["<", "<=", "==", ">=", ">"]
            },
            "value": {
              "type": "number"
            },
            "unit": {
              "type": "string"
            }
          }
        }
      }
    },
    "InterfaceRef": {
      "type": "object",
      "required": ["kind"],
      "properties": {
        "kind": {
          "type": "string",
          "enum": ["http", "rpc", "event", "model", "view", "function"]
        },
        "method": {
          "type": "string",
          "enum": ["GET", "POST", "PUT", "PATCH", "DELETE"]
        },
        "path": {
          "type": "string"
        },
        "request_schema_ref": {
          "type": "string",
          "pattern": "^#/schemas/[A-Za-z][A-Za-z0-9_]*$"
        },
        "response_schema_ref": {
          "type": "string",
          "pattern": "^#/schemas/[A-Za-z][A-Za-z0-9_]*$"
        },
        "model_name": {
          "type": "string"
        },
        "event_name": {
          "type": "string"
        }
      }
    },
    "SchemaDefinition": {
      "type": "object",
      "description": "JSON Schema for an interface or model",
      "properties": {
        "type": {
          "type": "string"
        },
        "properties": {
          "type": "object"
        },
        "required": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ArchitectureDecision": {
      "type": "object",
      "required": ["id", "title", "status", "decision"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^ADR-\\d{3,}$"
        },
        "title": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "enum": ["proposed", "accepted", "deprecated", "superseded"]
        },
        "context": {
          "type": "string"
        },
        "decision": {
          "type": "string"
        },
        "consequences": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "supersedes": {
          "type": "string",
          "pattern": "^ADR-\\d{3,}$"
        }
      }
    },
    "ComplianceRule": {
      "type": "object",
      "required": ["id", "regulation", "rule_type", "description"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^(BIR|PFRS|PAS|SOX|DOLE)_[A-Z0-9_-]+$"
        },
        "regulation": {
          "type": "string",
          "enum": ["BIR", "PFRS", "PAS", "SOX", "DOLE"],
          "description": "Regulatory body"
        },
        "rule_type": {
          "type": "string",
          "enum": ["tax_form", "accounting_standard", "labor_law", "audit_control", "data_privacy"]
        },
        "description": {
          "type": "string"
        },
        "source_url": {
          "type": "string",
          "format": "uri"
        },
        "validation_logic": {
          "type": "string",
          "description": "Python expression or function name for validation"
        },
        "effective_date": {
          "type": "string",
          "format": "date"
        },
        "expiry_date": {
          "type": "string",
          "format": "date"
        }
      }
    },
    "ModuleSpec": {
      "type": "object",
      "required": ["module_name", "category"],
      "properties": {
        "module_name": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_]*$"
        },
        "display_name": {
          "type": "string"
        },
        "category": {
          "type": "string",
          "enum": ["native_odoo", "oca", "custom"]
        },
        "depends": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "models": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "views": {
          "type": "array",
          "items": {
            "type": "string"
          }
        },
        "requirement_refs": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^REQ-\\d{3,}$"
          }
        }
      }
    },
    "Metadata": {
      "type": "object",
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "created_by": {
          "type": "string"
        },
        "pipeline_version": {
          "type": "string"
        },
        "target_system": {
          "type": "string",
          "enum": ["odoo18", "fastapi", "nextjs", "supabase"]
        },
        "compliance_validated": {
          "type": "boolean"
        },
        "validation_id": {
          "type": "string"
        }
      }
    }
  }
}
