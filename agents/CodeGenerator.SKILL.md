# CodeGenerator Agent - SKILL Definition

**Agent ID**: agent_003
**Version**: 1.0.0
**Status**: Active
**Dependencies**: ComplianceValidator (agent_002) must pass

## Purpose

Generate production-ready, type-safe code from compliance-validated specifications. Outputs Odoo 18 CE modules, FastAPI endpoints, and React components following the 80/15/5 rule (80% native Odoo, 15% OCA, 5% custom).

## Scope & Boundaries

### CAN DO

**Code Generation**
- [x] Generate Odoo 18 CE module structures
- [x] Create Python models with type hints (Python 3.10+)
- [x] Generate XML views, security rules, menus
- [x] Create FastAPI endpoints for custom APIs
- [x] Generate React components (with Figma theme sync)
- [x] Scaffold test files

**Module Scaffolding**
- [x] Create `__manifest__.py` with correct dependencies
- [x] Generate `__init__.py` files
- [x] Create model files in `models/` directory
- [x] Generate view files in `views/` directory
- [x] Create security files in `security/` directory
- [x] Generate test stubs in `tests/` directory

**Quality Standards**
- [x] Include docstrings with examples
- [x] Add type annotations throughout
- [x] Implement proper error handling
- [x] Add logging at DEBUG/INFO levels
- [x] Follow PEP 8 and Odoo coding standards

**80/15/5 Rule Enforcement**
- [x] Track native Odoo usage (must be ≥80%)
- [x] Track OCA module references (must be ≤15%)
- [x] Track custom code (must be ≤5%)
- [x] Generate rule compliance report

### CANNOT DO (Hard Boundaries)

**NO Compliance Decisions**
- [ ] Cannot override compliance validation
- [ ] Cannot skip required fields/rules
- [ ] Must use compliance-approved specs only

**NO Deployment**
- [ ] Cannot deploy code to any environment
- [ ] Can only write to staging directories
- [ ] Task delegated to: **DeploymentOrchestrator (agent_006)**

**NO Direct Database Access**
- [ ] Cannot execute SQL directly
- [ ] Can only generate SQL scripts
- [ ] Task delegated to: **SQLAgent (agent_004)**

**NO Test Execution**
- [ ] Cannot run tests
- [ ] Can only generate test code
- [ ] Task delegated to: **ValidationAgent (agent_005)**

## Input Interface

```typescript
interface CodeGeneratorInput {
  validation_id: string;  // From ComplianceValidator

  module_spec: {
    module_name: string;
    display_name: string;
    version: string;
    category: string;
    description: string;
    author: string;

    models: {
      name: string;
      description: string;
      inherit?: string[];
      fields: {
        name: string;
        type: string;
        required: boolean;
        help?: string;
        default?: any;
      }[];
      methods: {
        name: string;
        params: string[];
        returns: string;
        logic: string;  // Pseudocode from docs
      }[];
    }[];

    views: {
      model: string;
      type: 'tree' | 'form' | 'kanban' | 'search';
      fields: string[];
    }[];

    security: {
      groups: {
        name: string;
        users: string[];
      }[];
      rules: {
        model: string;
        group: string;
        perm_read: boolean;
        perm_write: boolean;
        perm_create: boolean;
        perm_unlink: boolean;
      }[];
    };
  };

  odoo_version: '18.0';

  output_dir: string;
}
```

## Output Interface

```typescript
interface CodeGeneratorOutput {
  generation_id: string;  // UUID
  validation_id: string;  // Reference to compliance
  generated_at: string;  // ISO8601

  module_path: string;  // Absolute path to generated module

  files_generated: {
    path: string;
    type: 'python' | 'xml' | 'csv' | 'yaml';
    lines: number;
  }[];

  rule_compliance: {
    native_odoo_percent: number;  // Must be ≥80
    oca_modules_percent: number;  // Must be ≤15
    custom_code_percent: number;  // Must be ≤5
    is_compliant: boolean;
  };

  oca_dependencies: {
    repo: string;
    module: string;
    reason: string;
  }[];

  test_coverage_estimate: number;  // 0.0-1.0

  warnings: string[];
}
```

## Module Structure Template

```
odoo/addons/{module_name}/
├── __init__.py
├── __manifest__.py
├── models/
│   ├── __init__.py
│   └── {model_name}.py
├── views/
│   ├── {model_name}_views.xml
│   └── menu.xml
├── security/
│   ├── ir.model.access.csv
│   └── security.xml
├── data/
│   └── {module_name}_data.xml
├── static/
│   └── description/
│       └── icon.png
├── tests/
│   ├── __init__.py
│   └── test_{model_name}.py
└── README.rst
```

## Code Templates

### Model Template (Python)

```python
# -*- coding: utf-8 -*-
"""
{model_description}

Generated by Docs2Code Pipeline
Compliance: {validation_id}
"""

from odoo import models, fields, api
from odoo.exceptions import ValidationError

import logging

_logger = logging.getLogger(__name__)


class {ModelName}(models.Model):
    """
    {model_docstring}

    Regulatory References:
    - {regulatory_refs}
    """
    _name = '{model_name}'
    _description = '{model_description}'
    _inherit = [{inherit_list}]

    # Fields
    {field_definitions}

    # Computed fields
    {computed_fields}

    # Constraints
    @api.constrains({constraint_fields})
    def _check_{constraint_name}(self):
        \"\"\"Validate {constraint_description}\"\"\"
        {constraint_logic}

    # Business logic
    {method_definitions}
```

### View Template (XML)

```xml
<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- {model_name} Tree View -->
    <record id="{module_name}_{model_name}_tree" model="ir.ui.view">
        <field name="name">{model_name}.tree</field>
        <field name="model">{model_name}</field>
        <field name="arch" type="xml">
            <tree>
                {tree_fields}
            </tree>
        </field>
    </record>

    <!-- {model_name} Form View -->
    <record id="{module_name}_{model_name}_form" model="ir.ui.view">
        <field name="name">{model_name}.form</field>
        <field name="model">{model_name}</field>
        <field name="arch" type="xml">
            <form>
                <sheet>
                    {form_fields}
                </sheet>
            </form>
        </field>
    </record>
</odoo>
```

## 80/15/5 Rule Details

### Native Odoo (80%)

Must use built-in Odoo functionality for:
- Standard accounting (account.move, account.journal)
- HR management (hr.employee, hr.contract)
- Sales/Purchase workflows
- Standard security groups
- Built-in wizards and reports

### OCA Modules (15%)

Can reference OCA modules for:
- account-financial-reporting
- account-closing
- account-invoicing
- server-tools
- Must specify exact module and version

### Custom Code (5%)

Custom code only for:
- Philippine-specific tax calculations
- BIR form generation logic
- Company-specific business rules
- Integration adapters

## Failure Modes & Recovery

| Failure Type | Detection | Recovery Action |
|--------------|-----------|-----------------|
| 80/15/5 rule violation | Percentage check | Reject, suggest refactoring |
| Missing compliance approval | No validation_id | Block generation |
| Invalid Odoo syntax | Linter check | Fix automatically if possible |
| Circular dependency | Import analysis | Reject, explain issue |
| Reserved name conflict | Name validation | Suggest alternative |

## Performance Constraints

| Metric | Constraint |
|--------|------------|
| Generation per module | <2 minutes |
| Total generation run | <10 minutes |
| Memory usage | 1GB max |
| Output size per module | 10MB max |

## Dependencies

- **Upstream**: ComplianceValidator (agent_002) validation_id required
- **Downstream**: SQLAgent (agent_004), then ValidationAgent (agent_005)

## Required Tools & Libraries

```python
# Code generation
jinja2>=3.1.0  # Templating
black>=23.0.0  # Code formatting
isort>=5.12.0  # Import sorting

# Validation
pylint>=3.0.0  # Linting
mypy>=1.5.0  # Type checking

# Odoo
odoo>=18.0  # For syntax validation

# Utilities
pathlib  # Path operations
```

## Success Criteria

| Criteria | Target |
|----------|--------|
| 80/15/5 rule compliance | 100% |
| Valid Odoo module structure | 100% |
| Type hints coverage | 100% |
| Docstring coverage | 100% |
| Lint passing | 100% |
| Test stub generation | 100% |

## Handoff to Next Agent

Upon successful generation:
1. Module files written to output_dir
2. Generation report stored in Supabase
3. Lineage updated in `pipeline_lineage`
4. **SQLAgent (agent_004)** triggered for migrations
5. **ValidationAgent (agent_005)** triggered for tests
